## 2022.6

为了尽可能地还原原游戏，我们需要一些手段获取到原游戏 swf 文件及其信息，方法就是使用软件 Flash Decompiler Trillix。然后我们就面临着一个严重的问题：这些素材需要我们自己拼接这就是最麻烦的地方。当然，我们也有自己的解决办法，我们可以写一个动画生成工具，当然现在还不需要。现在我们完全可以拿一张 png 格式的图片来暂时替代图片。

为了提高游戏体验，我们可以将游戏画面尽可能地做大，熟悉前端的朋友们应该意识到了，flex 布局是最佳选择。我们先搞一个 div，然后加上一些简单的 css 效果。这里我们使用 less 作为 style 语言。我们简单地写一下让游戏居中显示。

![1](./images/stage1/1.png)

然后我们需要测量游戏画面的长宽比（吐槽一下国产浏览器太慢了），经过测量，长宽比为 16:9，那么我们可以监听页面的 resize 事件，实时让游戏画面尽可能大地显示

## 2023.2.7

下面我们需要获取游戏的图片等信息，需要用到 Flash Decompiler Trillix 对游戏的 swf 文件反编译。在支持 flash 的浏览器中，我们可以按下 F12 打开浏览器的控制台，然后选择网络，监听网络活动，然后在筛选器中输入 swf，筛选出所有的 swf 文件

![2](./images/stage1/image.png)

## 加载界面

首先是写一个加载界面。我们将 TDLoaderUI.swf 下载下来并提取，会发现加载界面的所有的文字都是图片，这就给我们显示文字带来了很大的难度。但好在其他的地方都是可以通过图片的相互堆叠来实现。在控制台获取加载界面的背景图 loadingbg.jpg，然后使用 ai 高清修复图片高清化一下。下面我们就可以搭一个加载界面出来了。我们先来明确一下制作加载界面的步骤：

1. 绘制背景图
2. 绘制进度条
3. 绘制进度文字
4. 绘制 360 急救箱（这个真的需要吗）

显然，我们需要用 canvas 进行绘制（我不习惯用 pixi，所以没用它）。而首先，我们需要加载这几个用到的图片。那么我们就需要写一个加载系统，用来加载需要的资源。那么我们就先写一个加载类出来。首先列出来一个加载类需要的一些基础功能：

### 加载类

-   添加加载任务
-   获取加载进度，但理论上不能从外部设置，因此需要用 setter 和 getter
-   绑定加载进度的数值（由于使用了 vue，因此可以直接绑定到一个响应式变量上）
-   执行加载任务
-   监听加载是否完成

下面我们需要设计加载任务类。加载任务类应该有以下几个功能：

-   设置加载时执行的函数，或者是设置加载的地址，这里我们选择前者
-   监听任务的加载进度
-   监听任务是否加载完成
-   执行加载任务

列出所有功能后我们就可以写出 api 了。

这些函数的实现较为简单，不再列出具体实现。具体实现可以在 github 查看源码。

### 加载图片

下面是加载图片与图片缓存。我们安装 axios 依赖用来发起请求。加载一般就是加载图片和音频，因此可以针对这两个内容包装成两个函数。注意加载完毕后我们需要将它缓存起来以便后续使用。于是我们可以写出一个简易的 api 了。

这些函数的实现都比较简单，不再列出具体实现。

### 加载需要的资源

加载界面需要的图片在提取加载界面的 swf 文件时已经获得了，把这些图片放到 public 文件夹的 loading 文件夹即可。我们会发现没有“加载中”和“·”这四个字符的图片，因此就不加了，那么就直接加载剩余的图片。这些资源是需要在游戏开始前就要加载的，因此直接在 main.ts 里面写。这里我单独使用了一个 init.ts 用于初始化游戏并加载所需资源，然后使用 loadResource 函数包装了三个加载函数。这样我们便可以通过简单的调用来进行加载了。当初始资源加载完成后，我们就可以制作加载界面了。

### 制作加载界面

加载界面需要用 canvas 进行制作。我们需要拿 vue 写一个组件，这个组件需要包含一个 props，表示当前进度。绘制的时候使用 canvas2d 即可。我们使用 Flash Decompiler Trillix 把 swf 文件转换成 fla 文件，然后拿 adobe flash 打开，这样就知道了每个图片对应的位置。然后我们来进行绘制。我们发现，整个游戏的像素宽高为 950\*600（之前 16:9 算错了）。然后我们先创建一个画布，然后缩放至合适大小。然后是进行绘制。

### 绘制加载界面

由于游戏中大部分内容都是图片和文字，因此我们可以写一个简单的 canvas2d 布局系统，包含 image, imageText, text 三个绘制方法及若干功能方法。下面我们就可以使用这个布局系统绘制加载界面了。

至此，游戏的第一个界面——加载界面正式完工！

## 加载游戏信息

写完加载界面之后，下面便是进行加载了。进入游戏后，我们默认在美味镇，因此我们需要加载美味镇相关的素材与音乐。我们提取 TDTownUI.swf，即可获取到所有的图片，在游戏的控制台中过滤出 mp3 文件，即可找到名为 chengzhen_01.mp3 的背景音乐。而这些也是我们初始加载所需要的内容。
